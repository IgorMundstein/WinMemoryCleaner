name: Update doc images

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  packages: read

concurrency:
  group: update-release-images
  cancel-in-progress: true

jobs:
  update-main-window-screenshot:
    name: Update Main Window Screenshot
    runs-on: windows-latest

    steps:
      - name: checkout-repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          token: ${{ secrets.PAT_TOKEN }}

      - name: Download signed EXE from release
        id: download-exe
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.event.release.tag_name }}
        shell: pwsh
        run: |
          gh release download $env:TAG --pattern "WinMemoryCleaner.exe"
          if (-not (Test-Path ".\WinMemoryCleaner.exe")) {
            Write-Host "::error::Failed to download WinMemoryCleaner.exe from release $env:TAG"
            exit 1
          }
          Write-Host "Downloaded signed WinMemoryCleaner.exe"

      - name: Capture window screenshot from SIGNED exe
        id: capture_screenshot
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $appPath = ".\WinMemoryCleaner.exe"
          $windowScreenshotPath = "$pwd\main-window-raw.png"
          $proc = Start-Process -FilePath $appPath -PassThru
          $maxWaitMs = 15000; $elapsed = 0
          while ($proc.MainWindowHandle -eq 0 -and $elapsed -lt $maxWaitMs) {
            Start-Sleep -Milliseconds 200; $proc.Refresh(); $elapsed += 200
          }
          if ($proc.MainWindowHandle -eq 0) {
            Write-Host "::error::Main window not found for signed EXE."
            Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue
            exit 1
          }
          Add-Type -AssemblyName System.Drawing
          $sig = 'using System; using System.Runtime.InteropServices; public static class Win32 { [StructLayout(LayoutKind.Sequential)] public struct RECT { public int Left; public int Top; public int Right; public int Bottom; } [DllImport("user32.dll")] public static extern bool GetWindowRect(IntPtr hWnd, ref RECT rect); [DllImport("user32.dll")] public static extern bool SetForegroundWindow(IntPtr hWnd); }'
          Add-Type -TypeDefinition $sig -Language CSharp
          [void][Win32]::SetForegroundWindow([IntPtr]$proc.MainWindowHandle)
          $rect = New-Object Win32+RECT
          if (-not [Win32]::GetWindowRect([IntPtr]$proc.MainWindowHandle, [ref]$rect)) {
            Write-Host "::error::GetWindowRect failed."
            Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue; exit 1
          }
          $width = $rect.Right - $rect.Left; $height = $rect.Bottom - $rect.Top
          if ($width -le 0 -or $height -le 0) {
            Write-Host "::error::Invalid window size: $($width)x$($height)"
            Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue; exit 1
          }
          $wbmp = New-Object System.Drawing.Bitmap $width, $height
          $wgfx = [System.Drawing.Graphics]::FromImage($wbmp)
          $wgfx.CopyFromScreen($rect.Left, $rect.Top, 0, 0, (New-Object System.Drawing.Size($width, $height)))
          $wbmp.Save($windowScreenshotPath, [System.Drawing.Imaging.ImageFormat]::Png)
          $wgfx.Dispose(); $wbmp.Dispose()
          Stop-Process -Id $proc.Id -Force

      - name: check-screenshot-exists
        id: check-screenshot
        shell: bash
        run: |
          if [ -f "./main-window-raw.png" ]; then
            echo "screenshot_exists=true" >> $GITHUB_OUTPUT
          else
            echo "::error::Screenshot was not created."
            echo "screenshot_exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: install-imagemagick
        if: steps.check-screenshot.outputs.screenshot_exists == 'true'
        run: choco install imagemagick
        shell: pwsh

      - name: process-screenshot-image
        if: steps.check-screenshot.outputs.screenshot_exists == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p docs/assets/images
          FILE="./main-window-raw.png"
          if ! identify -format "%w %h" "$FILE" > /dev/null; then
            echo "::error::Failed to read image $FILE with ImageMagick."
            exit 1
          fi
          read W H < <(identify -format "%w %h" "$FILE")
          if [ -z "${W:-}" ] || [ -z "${H:-}" ]; then
            echo "::error::Failed to get image size for $FILE"
            exit 1
          fi
          if [ "$W" -lt "$H" ]; then MIN=$W; else MIN=$H; fi
          R=$(( MIN / 50 ))
          if [ "$R" -lt 10 ]; then R=10; fi
          if [ "$R" -gt 24 ]; then R=24; fi

          magick convert "$FILE" \
            \( -size "${W}x${H}" xc:none -fill white -draw "roundrectangle 0,0,$((W-1)),$((H-1)),$R,$R" \) \
            -compose DstIn -composite \
            docs/assets/images/main-window.png

          if [ ! -s docs/assets/images/main-window.png ]; then
            echo "::error::Image processing failed and output file was not created."
            exit 1
          fi

      - name: create-pull-request
        id: cpr
        if: steps.check-screenshot.outputs.screenshot_exists == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: "chore(docs): update main-window.png"
          title: "Docs: Update Main Window Screenshot for Release"
          body: |
            This is an automated PR to update the main window screenshot.
            It will be automatically merged once all status checks pass.
          branch: "docs/main-window-update-${{ github.run_id }}"
          base: main
          delete-branch: true
          add-paths: |
            docs/assets/images/main-window.png
          committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>

      - name: auto-merge-pull-request
        if: steps.check-screenshot.outputs.screenshot_exists == 'true' && steps.cpr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          PR_NUMBER: ${{ steps.cpr.outputs.pull-request-number }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          n=1
          until gh pr merge $PR_NUMBER --repo $REPO --squash --auto --delete-branch || [ $n -ge 3 ]; do
            echo "Auto-merge failed, retrying in 10s... (attempt $n of 3)"
            sleep 10
            n=$((n+1))
          done
