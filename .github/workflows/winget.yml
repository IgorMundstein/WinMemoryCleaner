name: Submit to WinGet

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read

env:
  FORK_REPO: ${{ github.repository_owner }}/WinGet
  UPSTREAM_REPO: microsoft/winget-pkgs
  PACKAGE_ID: ${{ github.repository_owner }}.WinMemoryCleaner

jobs:
  generate-manifests:
    name: Generate WinGet Manifests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      skip: ${{ steps.check_winget.outputs.skip }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Get latest release tag
        id: get_release
        uses: actions/github-script@v7
        with:
          script: |
            const { data: release } = await github.rest.repos.getLatestRelease({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const tag = release.tag_name;
            core.setOutput('tag', tag);
            return tag;

      - name: Validate inputs
        run: |
          if [ -z "${{ secrets.WINGET_TOKEN }}" ]; then
            echo "::error::WINGET_TOKEN secret is not set!"
            exit 1
          fi

      - name: Check if version already exists
        id: check_winget
        run: |
          HTTP_CODE=$(curl -s -w "%{http_code}" -o /dev/null \
            "https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/contents/manifests/i/${{ github.repository_owner }}/WinMemoryCleaner/${{ steps.get_release.outputs.tag }}")
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "::notice::Version ${{ steps.get_release.outputs.tag }} already exists. Skipping."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "::notice::Version not found. Proceeding with submission."
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Download release and get SHA256
        if: steps.check_winget.outputs.skip == 'false'
        id: download
        run: |
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.get_release.outputs.tag }}/WinMemoryCleaner.exe"
          echo "::notice::Downloading from $DOWNLOAD_URL"

          curl -fL --retry 3 --retry-delay 5 -o WinMemoryCleaner.exe "$DOWNLOAD_URL"
          
          SHA256=$(sha256sum WinMemoryCleaner.exe | cut -d ' ' -f1)
          echo "sha256=${SHA256}" >> $GITHUB_OUTPUT
          echo "::notice::SHA256: ${SHA256}"

      - name: Fetch repository metadata
        if: steps.check_winget.outputs.skip == 'false'
        id: metadata
        uses: actions/github-script@v7
        with:
          script: |
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            core.setOutput('desc', repo.description.trim());
            core.setOutput('homepage', repo.homepage || repo.html_url);
            core.setOutput('license', repo.license.spdx_id);

      - name: Create Manifest Files
        if: steps.check_winget.outputs.skip == 'false'
        id: create_manifest
        run: |
          set -e
          MANIFEST_DIR="winget-manifest"
          mkdir -p "$MANIFEST_DIR"
          
          cat > "${MANIFEST_DIR}/${{ env.PACKAGE_ID }}.yaml" <<EOF
          # yaml-language-server: \$schema=https://aka.ms/winget-manifest.version.1.6.0.schema.json
          PackageIdentifier: ${{ env.PACKAGE_ID }}
          PackageVersion: ${{ steps.get_release.outputs.tag }}
          DefaultLocale: en-US
          ManifestType: version
          ManifestVersion: 1.6.0
          EOF

          cat > "${MANIFEST_DIR}/${{ env.PACKAGE_ID }}.installer.yaml" <<EOF
          # yaml-language-server: \$schema=https://aka.ms/winget-manifest.installer.1.6.0.schema.json
          PackageIdentifier: ${{ env.PACKAGE_ID }}
          PackageVersion: ${{ steps.get_release.outputs.tag }}
          InstallerType: portable
          Installers:
          - Architecture: x64
            InstallerUrl: https://github.com/${{ github.repository }}/releases/download/${{ steps.get_release.outputs.tag }}/WinMemoryCleaner.exe
            InstallerSha256: ${{ steps.download.outputs.sha256 }}
            PortableCommand: WinMemoryCleaner.exe
          - Architecture: x86
            InstallerUrl: https://github.com/${{ github.repository }}/releases/download/${{ steps.get_release.outputs.tag }}/WinMemoryCleaner.exe
            InstallerSha256: ${{ steps.download.outputs.sha256 }}
            PortableCommand: WinMemoryCleaner.exe
          ManifestType: installer
          ManifestVersion: 1.6.0
          EOF

          cat > "${MANIFEST_DIR}/${{ env.PACKAGE_ID }}.locale.en-US.yaml" <<EOF
          # yaml-language-server: \$schema=https://aka.ms/winget-manifest.defaultLocale.1.6.0.schema.json
          PackageIdentifier: ${{ env.PACKAGE_ID }}
          PackageVersion: ${{ steps.get_release.outputs.tag }}
          PackageLocale: en-US
          Publisher: Igor Mundstein
          PackageName: Windows Memory Cleaner
          License: ${{ steps.metadata.outputs.license }}
          PackageUrl: ${{ steps.metadata.outputs.homepage }}
          ShortDescription: ${{ steps.metadata.outputs.desc }}
          Commands:
          - WinMemoryCleaner
          ManifestType: defaultLocale
          ManifestVersion: 1.6.0
          EOF

      - name: Upload Manifest Artifact
        if: steps.check_winget.outputs.skip == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: winget-manifest
          path: winget-manifest

  validate-and-submit:
    name: Validate and Submit to WinGet
    needs: generate-manifests
    if: needs.generate-manifests.outputs.skip == 'false'
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Download Manifest Artifact
        uses: actions/download-artifact@v4
        with:
          name: winget-manifest

      - name: Validate Manifests with WinGet CLI
        run: winget validate .

      - name: Get Package Version from Manifest
        id: manifest_data
        shell: bash
        run: |
          version=$(grep PackageVersion ${{ env.PACKAGE_ID }}.yaml | cut -d ' ' -f2)
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.WINGET_TOKEN }}
        shell: bash
        run: |
          set -e
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git clone "https://x-access-token:${{ env.GH_TOKEN }}@github.com/${{ env.FORK_REPO }}.git" winget-fork
          cd winget-fork
          git remote add upstream "https://github.com/${{ env.UPSTREAM_REPO }}.git"
          git fetch upstream master --depth=1
          
          VERSION=${{ steps.manifest_data.outputs.version }}
          BRANCH_NAME="add/${{ github.repository_owner }}/WinMemoryCleaner/${VERSION}"
          git checkout -b "$BRANCH_NAME" upstream/master
          
          mkdir -p "manifests/i/${{ github.repository_owner }}/WinMemoryCleaner/${VERSION}"
          cp ../*.yaml "manifests/i/${{ github.repository_owner }}/WinMemoryCleaner/${VERSION}/"
          
          git add .
          git commit -m "Add ${{ env.PACKAGE_ID }} version ${VERSION}"
          git push origin "$BRANCH_NAME"
          
          gh pr create \
            --repo "${{ env.UPSTREAM_REPO }}" \
            --head "$(echo ${{ env.FORK_REPO }} | cut -d'/' -f1):${BRANCH_NAME}" \
            --base master \
            --title "Add ${{ env.PACKAGE_ID }} ${VERSION}" \
            --body "Automated submission for ${{ env.PACKAGE_ID }} version ${VERSION}."
            
          echo "::notice::Pull request created successfully."
