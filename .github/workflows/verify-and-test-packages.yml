name: Verify and Test Packages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'
  release:
    types: [published]

jobs:
  setup:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      release_version: ${{ steps.get_version.outputs.RELEASE_VERSION }}
      cache-hit: ${{ steps.cache_check.outputs.cache-hit }}
      cache-key: ${{ steps.cache_check.outputs.cache-primary-key }}
    steps:
      - name: "â³ Add grace period after release publication"
        if: github.event_name == 'release'
        run: sleep 1800

      - name: "ðŸ”½ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ·ï¸ Get Latest Release Version"
        id: get_version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          latest_tag=$(gh release view --json tagName --jq .tagName)
          if [ -z "$latest_tag" ]; then
            echo "No releases found. Halting workflow."
            exit 1
          fi
          version=$(echo "$latest_tag" | sed 's/v//')
          echo "RELEASE_VERSION=$version" >> "$GITHUB_OUTPUT"
          echo "Checking for version: $version"

      - name: "ðŸ—„ï¸ Check if Already Verified via Cache"
        id: cache_check
        uses: actions/cache/restore@v4
        with:
          path: ./.cache
          key: verification-flag-v${{ steps.get_version.outputs.RELEASE_VERSION }}

  choco:
    needs: setup
    if: needs.setup.outputs.cache-hit != 'true'
    runs-on: windows-latest
    outputs:
      published: ${{ steps.choco.outputs.published }}
      e2e: ${{ steps.choco.outputs.e2e_result }}
    steps:
      - name: "ðŸ« Chocolatey Verify and Test"
        id: choco
        shell: pwsh
        env:
          RELEASE_VERSION: ${{ needs.setup.outputs.release_version }}
        run: |
          $ErrorActionPreference = 'Stop'
          $version = "$env:RELEASE_VERSION"
          $packageName = "winmemorycleaner"
          $e2e_result = "fail"
          $published = "false"
          Write-Host "===[Chocolatey] Checking $packageName version $version==="
          try {
            $choco_output = choco search $packageName --exact --all-versions -r
            Write-Host "Chocolatey search output:`n$choco_output"
            if ($choco_output -match "$version") {
              Write-Host "[Chocolatey] âœ… Version found."
              $published = "true"
              Write-Host "[Chocolatey] Installing package..."
              choco install $packageName --version $version -y --no-progress
              $exe = Get-Command WinMemoryCleaner.exe -ErrorAction SilentlyContinue
              if ($null -eq $exe) {
                Write-Host "[Chocolatey] âŒ WinMemoryCleaner.exe not found after install"
                $e2e_result = "fail"
              } else {
                Write-Host "[Chocolatey] Running version command..."
                & $exe.Source --version | Write-Host
                $e2e_result = "success"
                Write-Host "[Chocolatey] âœ… E2E Test successful."
              }
            } else {
              Write-Host "[Chocolatey] âŒ Version not found."
            }
          } catch {
            Write-Host "[Chocolatey] âŒ Error: $($_.Exception.Message)"
            $e2e_result = "fail"
          }
          echo "published=$published" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          echo "e2e_result=$e2e_result" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

  scoop:
    needs: setup
    if: needs.setup.outputs.cache-hit != 'true'
    runs-on: windows-latest
    outputs:
      published: ${{ steps.scoop.outputs.published }}
      e2e: ${{ steps.scoop.outputs.e2e_result }}
    steps:
      - name: "ðŸ¦ Scoop Verify and Test"
        id: scoop
        shell: pwsh
        env:
          RELEASE_VERSION: ${{ needs.setup.outputs.release_version }}
        run: |
          $ErrorActionPreference = 'Stop'
          $version = "$env:RELEASE_VERSION"
          $packageName = "winmemorycleaner"
          $e2e_result = "fail"
          $published = "false"
          Write-Host "===[Scoop] Ensuring Scoop is installed==="
          try {
            if (-not (Get-Command scoop -ErrorAction SilentlyContinue)) {
              irm get.scoop.sh | iex
            }
            scoop update
            scoop bucket add extras -f
            scoop update extras
            Write-Host "===[Scoop] Checking $packageName version $version==="
            $scoop_info = scoop info $packageName
            Write-Host "Scoop info output:`n$scoop_info"
            if ($scoop_info -match "Version:\s*$version") {
              Write-Host "[Scoop] âœ… Version found."
              $published = "true"
              Write-Host "[Scoop] Installing package..."
              scoop install $packageName
              $exe = "$(scoop prefix $packageName)\WinMemoryCleaner.exe"
              if (-not (Test-Path $exe)) {
                Write-Host "[Scoop] âŒ WinMemoryCleaner.exe not found after install"
                $e2e_result = "fail"
              } else {
                Write-Host "[Scoop] Running version command..."
                & $exe --version | Write-Host
                $e2e_result = "success"
                Write-Host "[Scoop] âœ… E2E Test successful."
              }
            } else {
              Write-Host "[Scoop] âŒ Version not found."
            }
          } catch {
            Write-Host "[Scoop] âŒ Error: $($_.Exception.Message)"
            $e2e_result = "fail"
          }
          echo "published=$published" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          echo "e2e_result=$e2e_result" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

  winget_cli:
    needs: setup
    if: needs.setup.outputs.cache-hit != 'true'
    runs-on: windows-latest
    outputs:
      found: ${{ steps.detect_winget.outputs.found }}
      published: ${{ steps.winget.outputs.published }}
      e2e: ${{ steps.winget.outputs.e2e_result }}
    steps:
      - name: "ðŸ”Ž Detect WinGet CLI & Version"
        id: detect_winget
        shell: pwsh
        run: |
          $found = 'false'
          $wingetPath = ''
          try {
            $wingetCmd = Get-Command winget -ErrorAction Stop
            $found = 'true'
            $wingetPath = $wingetCmd.Source
          } catch {
            $possiblePath = "$env:LOCALAPPDATA\Microsoft\WindowsApps\winget.exe"
            if (Test-Path $possiblePath) {
              $found = 'true'
              $wingetPath = $possiblePath
            }
          }
          Write-Host "===[WinGet] Found: $found"
          Write-Host "===[WinGet] Path: $wingetPath"
          echo "found=$found" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          echo "path=$wingetPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: "ðŸ“¦ WinGet CLI Verify and Test"
        id: winget
        if: steps.detect_winget.outputs.found == 'true'
        shell: pwsh
        env:
          RELEASE_VERSION: ${{ needs.setup.outputs.release_version }}
        run: |
          $version_to_check = "$env:RELEASE_VERSION"
          $wingetExe = "${{ steps.detect_winget.outputs.path }}"
          if (-not (Test-Path $wingetExe)) { $wingetExe = "winget.exe" }
          $pkgName = "IgorMundstein.WinMemoryCleaner"
          $published = "false"
          $e2e_result = "fail"
          Write-Host "===[WinGet] Using $wingetExe"
          try {
            Write-Host "[WinGet] Updating sources..."
            try { & $wingetExe source update } catch { Write-Host "[WinGet] source update failed (non-fatal)" }
            Write-Host "[WinGet] Showing package info..."
            $winget_output = & $wingetExe show --id $pkgName --source winget --accept-source-agreements
            Write-Host "WinGet show output:`n$winget_output"
            if ($winget_output -match "Version:\s*$version_to_check") {
              Write-Host "[WinGet] âœ… Version found."
              $published = "true"
              Write-Host "[WinGet] Installing package..."
              & $wingetExe install --id $pkgName --accept-source-agreements --accept-package-agreements --silent -o .
              if (-not (Test-Path ".\WinMemoryCleaner.exe")) {
                Write-Host "[WinGet] âŒ WinMemoryCleaner.exe not found after install"
                $e2e_result = "fail"
              } else {
                Write-Host "[WinGet] Running version command..."
                .\WinMemoryCleaner.exe --version | Write-Host
                $e2e_result = "success"
                Write-Host "[WinGet] âœ… E2E Test successful."
              }
            } else {
              Write-Host "[WinGet] âŒ Version not found."
            }
          } catch {
            Write-Host "[WinGet] âŒ Error: $($_.Exception.Message)"
            $e2e_result = "fail"
          }
          echo "published=$published" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          echo "e2e_result=$e2e_result" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

  winget_manifest:
    needs: setup
    if: needs.setup.outputs.cache-hit != 'true'
    runs-on: ubuntu-latest
    outputs:
      published: ${{ steps.check_manifest.outputs.published }}
    steps:
      - name: "ðŸŒ Check WinGet Manifest in winget-pkgs"
        id: check_manifest
        shell: pwsh
        env:
          PKG_ID: IgorMundstein.WinMemoryCleaner
          RELEASE_VERSION: ${{ needs.setup.outputs.release_version }}
        run: |
          $ErrorActionPreference = 'Stop'
          $owner = "microsoft"
          $repo = "winget-pkgs"
          $id = "${env:PKG_ID}"
          $ver = "${env:RELEASE_VERSION}"
          $verPath = $ver -replace '\.', '_'
          $manifestPath = "$($id -replace '\.', '/')/$verPath"
          $url = "https://api.github.com/repos/$owner/$repo/contents/manifests/$manifestPath"
          Write-Host "Checking manifest existence: $url"
          try {
            $response = Invoke-RestMethod -Uri $url -Method Get
            Write-Host "âœ… Manifest for $id $ver found in winget-pkgs!"
            echo "published=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } catch {
            Write-Host "âŒ Manifest for $id $ver NOT found in winget-pkgs."
            echo "published=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

  summarize:
    needs: [choco, scoop, winget_cli, winget_manifest]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: "ðŸ“ Publication Summary"
        run: |
          echo "### Publication Verification for v${{ needs.choco.outputs.release_version }}" >> $GITHUB_STEP_SUMMARY
          echo "| Package Manager | Publication Status | E2E Test |" >> $GITHUB_STEP_SUMMARY
          echo "|----------------|-------------------|----------|" >> $GITHUB_STEP_SUMMARY

          # Chocolatey
          CH_PUB="${{ needs.choco.outputs.published }}"
          CH_E2E="${{ needs.choco.outputs.e2e }}"
          if [ "$CH_PUB" == "true" ]; then CH_STATUS="âœ… Published"; else CH_STATUS="âŒ Not Published"; fi
          if [ "$CH_E2E" == "success" ]; then CH_E2E_STATUS="âœ… Passed"; elif [ "$CH_PUB" == "true" ]; then CH_E2E_STATUS="âŒ Failed"; else CH_E2E_STATUS="âš ï¸ Skipped"; fi
          echo "| ðŸ« Chocolatey | $CH_STATUS | $CH_E2E_STATUS |" >> $GITHUB_STEP_SUMMARY

          # Scoop
          SC_PUB="${{ needs.scoop.outputs.published }}"
          SC_E2E="${{ needs.scoop.outputs.e2e }}"
          if [ "$SC_PUB" == "true" ]; then SC_STATUS="âœ… Published"; else SC_STATUS="âŒ Not Published"; fi
          if [ "$SC_E2E" == "success" ]; then SC_E2E_STATUS="âœ… Passed"; elif [ "$SC_PUB" == "true" ]; then SC_E2E_STATUS="âŒ Failed"; else SC_E2E_STATUS="âš ï¸ Skipped"; fi
          echo "| ðŸ¦ Scoop      | $SC_STATUS | $SC_E2E_STATUS |" >> $GITHUB_STEP_SUMMARY

          # WinGet CLI
          WG_CLI_FOUND="${{ needs.winget_cli.outputs.found }}"
          WG_CLI_PUB="${{ needs.winget_cli.outputs.published }}"
          WG_CLI_E2E="${{ needs.winget_cli.outputs.e2e }}"
          if [ "$WG_CLI_FOUND" == "true" ]; then
            if [ "$WG_CLI_PUB" == "true" ]; then WG_CLI_STATUS="âœ… Published"; else WG_CLI_STATUS="âŒ Not Published"; fi
            if [ "$WG_CLI_E2E" == "success" ]; then WG_CLI_E2E_STATUS="âœ… Passed"; elif [ "$WG_CLI_PUB" == "true" ]; then WG_CLI_E2E_STATUS="âŒ Failed"; else WG_CLI_E2E_STATUS="âš ï¸ Skipped"; fi
            echo "| ðŸ“¦ WinGet CLI | $WG_CLI_STATUS | $WG_CLI_E2E_STATUS |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ“¦ WinGet CLI | âš ï¸ Not Available | âš ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          # WinGet Manifest
          WG_MANIFEST_PUB="${{ needs.winget_manifest.outputs.published }}"
          if [ "$WG_MANIFEST_PUB" == "true" ]; then
            WG_MANIFEST_STATUS="âœ… Manifest Published"
          else
            WG_MANIFEST_STATUS="âŒ Manifest Not Published"
          fi
          echo "| ðŸŒ WinGet Manifest | $WG_MANIFEST_STATUS | |" >> $GITHUB_STEP_SUMMARY

      - name: "ðŸ’¾ Save Success Flag to Cache"
        if: needs.choco.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ./.cache
          key: ${{ needs.setup.outputs.cache-key }}
